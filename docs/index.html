<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sadece Biz • Hafıza Deposu</title>
<style>
  :root{--bg:#f8e7ef;--fg:#2d2a32;--card:#ffffff;--soft:#f3f0ff;--acc:#7c3aed;}
  *{box-sizing:border-box} body{margin:0;font-family:Inter,system-ui,Arial,sans-serif;background:
  linear-gradient(135deg,#ffe5ee,#f1e8ff);color:var(--fg);min-height:100vh}
  header{position:sticky;top:0;z-index:5;background:linear-gradient(90deg,#a855f7,#ec4899);
  color:#fff;padding:14px 18px;font-weight:700;letter-spacing:.3px;box-shadow:0 8px 28px rgba(109,40,217,.25)}
  main{max-width:900px;margin:24px auto;padding:0 16px}
  .panel{background:var(--card);border-radius:16px;padding:16px 14px;box-shadow:0 10px 30px rgba(0,0,0,.08)}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  select,textarea,button{font:inherit}
  select,textarea{border:1px solid #e5e7eb;border-radius:12px;padding:10px 12px;background:#fff}
  select{height:40px}
  textarea{flex:1;min-height:60px;width:100%}
  button{border:0;border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer}
  .pri{background:#7c3aed;color:#fff} .sec{background:#eef2ff} .mut{background:#fde68a}
  .des{background:#fee2e2} .ghost{background:#fff}
  ul{list-style:none;margin:12px 0 0;padding:0}
  li{background:var(--card);border:1px solid #f1f5f9;border-radius:14px;padding:10px 12px;margin:8px 0}
  li b{color:#6d28d9} small{color:#64748b}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .hint{font-size:.9rem;color:#6b7280;margin-top:6px}
</style>
</head>
<body>
<header>🌸 Sadece Biz • Hafıza Deposu</header>
<main>
  <div class="panel">
    <div class="row">
      <select id="role">
        <option value="Hakan">Hakan</option>
        <option value="Zeliha">Zeliha</option>
      </select>
      <textarea id="msg" placeholder="Mesajı yaz ve “Ekle” de... (Ctrl+Enter)"></textarea>
    </div>
    <div class="toolbar">
      <button class="pri" id="add">Ekle</button>
      <button class="sec" id="export">Dışa aktar (JSON)</button>
      <button class="ghost" id="importBtn">İçe aktar</button>
      <input type="file" id="import" accept="application/json" hidden>
      <button class="des" id="clear">Tümünü sil</button>
      <span id="info" class="hint"></span>
    </div>
    <div class="hint">Bu sayfa verileri <b>yalnızca cihazındaki</b> tarayıcı hafızasında (localStorage) tutar.</div>
  </div>

  <ul id="list"></ul>
</main>

<script>
const KEY = 'sadeceBiz:konusmalar:v1';

const $ = s => document.querySelector(s);

function read(){ try{ return JSON.parse(localStorage.getItem(KEY)||'[]'); }catch{ return []; } }
function write(arr){ localStorage.setItem(KEY, JSON.stringify(arr)); }
function esc(s){ return s.replace(/[&<>]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;' }[c])); }

function render(){
  const arr = read().sort((a,b)=>a.t-b.t);
  const ul = $('#list'); ul.innerHTML = '';
  arr.forEach(m=>{
    const li = document.createElement('li');
    const d = new Date(m.t);
    li.innerHTML = `<b>${esc(m.role)}</b> · <small>${d.toLocaleString()}</small><br>${esc(m.text)}`;
    ul.appendChild(li);
  });
  $('#info').textContent = `${arr.length} kayıt`;
}

function add(role, text){
  role = role ?? $('#role').value;
  text = (text ?? $('#msg').value).trim();
  if(!text) return;
  const arr = read();
  arr.push({ t: Date.now(), role, text });
  write(arr); render();
  if(arguments.length<2) $('#msg').value = '';
}

$('#add').onclick = ()=> add();
$('#msg').addEventListener('keydown', e=>{ if(e.ctrlKey && e.key==='Enter') add(); });

$('#clear').onclick = ()=>{
  if(confirm('Tüm konuşma hafızasını silmek istiyor musun?')){
    write([]); render();
  }
};

$('#export').onclick = ()=>{
  const blob = new Blob([JSON.stringify(read(), null, 2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  const ts = new Date().toISOString().slice(0,10);
  a.download = `sadecebiz-hafiza-${ts}.json`;
  a.click(); URL.revokeObjectURL(a.href);
};

$('#importBtn').onclick = ()=> $('#import').click();
$('#import').onchange = e=>{
  const f = e.target.files[0]; if(!f) return;
  f.text().then(txt=>{
    let incoming=[]; try{ incoming = JSON.parse(txt); }catch{ alert('Geçersiz JSON'); return; }
    const cur = read();
    const merged = [...cur, ...incoming].sort((a,b)=>a.t-b.t);
    const uniq=[]; const seen=new Set();
    for(const m of merged){
      const k = `${m.t}|${m.role}|${m.text}`;
      if(!seen.has(k)){ seen.add(k); uniq.push(m); }
    }
    write(uniq); render();
  });
};

// Dış sayfalardan kayıt kabulü (isteğe bağlı)
window.addEventListener('message', ev=>{
  const d = ev.data || {};
  if(d && d.type==='sbiz:add' && d.text && d.role){
    add(d.role, d.text);
  }
});

// Küçük bir API da sunalım:
window.hafiza = {
  add, list:()=>read(), clear:()=>{ write([]); render(); }, key:KEY
};

render();
</script>
</body>
</html>
