<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Sadece Biz â€¢ Kontrol Paneli (KÄ±rp + GIF)</title>

<!-- Cropper.js (kÄ±rpma) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cropperjs@1.6.2/dist/cropper.min.css">
<script src="https://cdn.jsdelivr.net/npm/cropperjs@1.6.2/dist/cropper.min.js"></script>

<!-- gifshot (GIF Ã¼retici) -->
<script src="https://cdn.jsdelivr.net/npm/gifshot@0.4.5/build/gifshot.min.js"></script>

<style>
  :root{
    --m1:#6d28d9; --m2:#7c3aed; --ink:#1f2937; --muted:#6b7280;
    --card:#ffffff; --bg:linear-gradient(135deg,#ffe5f3 0%,#fde7ff 100%);
  }
  *{box-sizing:border-box} body{margin:0;font-family:Inter,system-ui,Segoe UI,Arial,sans-serif;color:var(--ink);background:var(--bg)}
  header{position:sticky;top:0;z-index:5;background:linear-gradient(90deg,var(--m1),var(--m2));color:#fff;padding:16px 20px;box-shadow:0 8px 24px rgba(109,40,217,.25)}
  h1{margin:0;font-size:22px;font-weight:800;letter-spacing:.2px}
  .wrap{max-width:980px;margin:22px auto;padding:0 14px}
  .section{background:var(--card);border-radius:18px;box-shadow:0 10px 30px rgba(17,24,39,.08);padding:16px 16px 18px;margin:18px 0}
  .section h2{margin:2px 0 12px;font-size:20px}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .btn{appearance:none;border:none;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
  .btn.primary{background:var(--m1);color:#fff}
  .btn.ghost{background:#f5f3ff;color:#4c1d95}
  .btn.warn{background:#fee2e2;color:#991b1b}
  .hint{font-size:.9rem;color:var(--muted)}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px;margin-top:12px}
  .card{border:1px solid #eef; border-radius:14px; overflow:hidden; background:#fff}
  .thumb{width:100%;aspect-ratio:1/1;object-fit:cover;display:block}
  .meta{padding:8px 10px;font-size:.85rem;color:#334155;word-break:break-all}
  .pill{display:inline-flex;align-items:center;gap:6px;background:#eef;border-radius:999px;padding:6px 10px;font-weight:600}
  input[type="range"]{width:220px}
  #cropImg{max-width:100%;max-height:48vh;border-radius:12px}
  #cropPreview{width:128px;height:128px;border-radius:12px;object-fit:cover;border:1px solid #eee;display:block}
  .divider{height:1px;background:#eee;margin:12px 0}
  .canvasBox{min-height:160px;display:flex;align-items:center;justify-content:center;background:#fafafa;border:1px dashed #ddd;border-radius:12px}
  .badge{font-size:.8rem;color:#475569}
  .stickyTools{position:sticky;top:64px;z-index:4;background:#fff;border-radius:14px;padding:10px;box-shadow:0 6px 18px rgba(2,6,23,.06)}
</style>
</head>
<body>

<header>
  <h1>ğŸŒ¸ Sadece Biz â€¢ Kontrol Paneli</h1>
  <div class="hint">Veriler bu cihazda saklanÄ±r (localStorage). DÄ±ÅŸa/Ä°Ã§e aktar ile yedek almayÄ± unutma ğŸ’¾</div>
</header>

<div class="wrap">

  <!-- RESÄ°MLER -->
  <section class="section" id="sec-images">
    <h2>ğŸ–¼ï¸ Resimler</h2>
    <div class="row">
      <label class="btn ghost">
        + Resim Ekle
        <input id="pickImages" type="file" accept="image/*" multiple style="display:none">
      </label>
      <button class="btn ghost" id="btnExport">â¬‡ï¸ DÄ±ÅŸa aktar (JSON)</button>
      <label class="btn ghost">â¬†ï¸ Ä°Ã§e aktar
        <input id="importJson" type="file" accept="application/json" style="display:none">
      </label>
      <button class="btn warn" id="btnClear">ğŸ—‘ï¸ Hepsini Sil</button>
      <span class="hint" id="imgCount">0 gÃ¶rsel</span>
    </div>
    <div class="grid" id="gallery"></div>
  </section>

  <!-- KIRPICI -->
  <section class="section" id="sec-crop">
    <h2>ğŸ“ FotoÄŸraf KÄ±rp (1:1 â†’ 512Ã—512)</h2>

    <div class="row stickyTools">
      <label class="btn ghost">
        ğŸ“ FotoÄŸraf SeÃ§
        <input id="pickForCrop" type="file" accept="image/*" style="display:none">
      </label>
      <button class="btn ghost" id="btnPickFromGallery">ğŸ—‚ï¸ Galeriden SeÃ§</button>
      <button class="btn ghost" id="btnStartCrop">KÄ±rpmayÄ± BaÅŸlat</button>
      <button class="btn primary" id="btnDoCrop">KÄ±rp ve Kullan</button>
      <span class="hint" id="cropStatus">â€”</span>
    </div>

    <div class="row" style="align-items:flex-start">
      <img id="cropImg" alt="">
      <div>
        <div class="hint">Ã–nizleme</div>
        <img id="cropPreview" alt="">
        <div class="hint badge" id="previewInfo"></div>
      </div>
    </div>
    <div class="divider"></div>
    <div class="hint">Ä°pucu: Ä°ki parmakla yakÄ±nlaÅŸtÄ±rÄ±p sÃ¼rÃ¼kleyebilirsin. â€œKÄ±rp ve Kullanâ€ sonrasÄ± gÃ¶rÃ¼ntÃ¼ GIF oluÅŸturucuya otomatik aktarÄ±lÄ±r.</div>
  </section>

  <!-- GIF OLUÅTURUCU -->
  <section class="section" id="sec-gif">
    <h2>ğŸ¬ GIF OluÅŸtur</h2>

    <div class="row">
      <button class="btn ghost" id="btnUseCropped">âœ³ï¸ KÄ±rpÄ±lmÄ±ÅŸ GÃ¶rseli Kullan</button>
      <button class="btn ghost" id="btnUseFromGallery">ğŸ—‚ï¸ Galeriden Kullan</button>
      <span class="hint" id="gifSourceHint">Kaynak: â€”</span>
    </div>

    <div class="row" style="margin-top:10px">
      <span class="pill">FPS
        <input id="fps" type="range" min="8" max="20" value="12">
        <span id="fpsVal" class="badge">12</span>
      </span>
      <span class="pill">SÃ¼re (sn)
        <input id="dur" type="range" min="1" max="6" value="2">
        <span id="durVal" class="badge">2</span>
      </span>
      <button class="btn primary" id="btnMakeGif">GIF OluÅŸtur</button>
      <a id="btnDownloadGif" class="btn ghost" download="anim.gif" href="#" style="pointer-events:none;opacity:.6">â¬‡ï¸ GIFâ€™i Ä°ndir</a>
      <span class="hint" id="gifStatus">â€”</span>
    </div>

    <div class="canvasBox" id="gifPreviewBox">
      <span class="hint">GIF hazÄ±r olduÄŸunda burada gÃ¶rÃ¼necek</span>
    </div>

    <!-- Kaynak gÃ¶sterim (gizli) -->
    <img id="gifSourceImg" alt="" style="display:none">
  </section>

</div>

<script>
/* ===================== Genel YardÄ±mcÄ±lar ===================== */
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);
const sleep = (ms) => new Promise(r => setTimeout(r, ms));

/* ===================== Resim Galerisi (localStorage) ===================== */
const LS_KEY = 'sb_images_v2';  // base64 dataURL listesi
let images = [];                // [{id, dataURL, name, ts}]

function loadImages(){
  try{ images = JSON.parse(localStorage.getItem(LS_KEY) || '[]'); }catch(_){ images=[]; }
  renderGallery();
}
function saveImages(){ localStorage.setItem(LS_KEY, JSON.stringify(images)); }

function renderGallery(){
  const g = $('#gallery'); g.innerHTML = '';
  $('#imgCount').textContent = `${images.length} gÃ¶rsel`;
  images.forEach((it, idx)=>{
    const card = document.createElement('div'); card.className='card';
    const img = document.createElement('img'); img.src = it.dataURL; img.className='thumb';
    const meta = document.createElement('div'); meta.className='meta'; meta.textContent = it.name || `resim-${idx+1}.png`;
    card.appendChild(img); card.appendChild(meta);
    // SeÃ§im iÃ§in tÄ±k
    card.addEventListener('click', ()=> {
      // crop kaynaÄŸÄ±na koy
      setCropSource(it.dataURL, 'Galeri');
      // gif kaynaÄŸÄ±na da hÄ±zlÄ±ca set etmek istersen:
      setGifSource(it.dataURL, 'Galeri');
      window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'});
    });
    g.appendChild(card);
  });
}

// Resim ekle
$('#pickImages').addEventListener('change', async (e)=>{
  const files = [...e.target.files];
  for(const f of files){
    const dataURL = await fileToDataURL(f);
    images.unshift({id:Date.now()+Math.random(), dataURL, name:f.name, ts: Date.now()});
  }
  saveImages(); renderGallery();
  e.target.value = '';
});

$('#btnClear').addEventListener('click', ()=>{
  if(!confirm('TÃ¼m gÃ¶rseller silinsin mi? Bu iÅŸlem geri alÄ±namaz.')) return;
  images = []; saveImages(); renderGallery();
});

$('#btnExport').addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(images)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'sadece-biz-galeri.json';
  a.click(); URL.revokeObjectURL(a.href);
});

$('#importJson').addEventListener('change', async (e)=>{
  const file = e.target.files?.[0]; if(!file) return;
  try{
    const txt = await file.text();
    const arr = JSON.parse(txt);
    if(!Array.isArray(arr)) throw 'GeÃ§ersiz JSON';
    images = arr.concat(images); // Ã¼ste ekle
    saveImages(); renderGallery();
  }catch(err){ alert('JSON iÃ§e aktarÄ±m hatasÄ±: '+err); }
  e.target.value='';
});

function fileToDataURL(file){
  return new Promise((res,rej)=>{
    const fr = new FileReader();
    fr.onload = () => res(fr.result);
    fr.onerror = rej;
    fr.readAsDataURL(file);
  });
}

/* ===================== KÄ±rpÄ±cÄ± ===================== */
let cropper = null;
let loadedURL = null;
window.croppedDataURL = "";  // dÄ±ÅŸarÄ± aÃ§Ä±k

function setCropSource(src, from='Dosya'){
  if(loadedURL){ try{ URL.revokeObjectURL(loadedURL); }catch(_){} }
  $('#cropImg').src = src;
  $('#cropStatus').textContent = `${from} yÃ¼klendi. 'KÄ±rpmayÄ± BaÅŸlat' ile dÃ¼zenleyebilirsin.`;
}

$('#pickForCrop').addEventListener('change', (e)=>{
  const f = e.target.files?.[0]; if(!f) return;
  loadedURL = URL.createObjectURL(f);
  setCropSource(loadedURL, 'Dosya');
  e.target.value='';
});

$('#btnPickFromGallery').addEventListener('click', ()=>{
  if(images.length===0){ alert('Galeride gÃ¶rsel yok. Ã–nce â€œResim Ekleâ€ ile ekle.'); return; }
  // En Ã¼sttekini Ã¶rnek olarak al
  const src = images[0].dataURL;
  setCropSource(src, 'Galeri');
});

$('#btnStartCrop').addEventListener('click', ()=>{
  const img = $('#cropImg'); if(!img.src){ $('#cropStatus').textContent='Ã–nce bir gÃ¶rsel seÃ§.'; return; }
  if(cropper){ cropper.destroy(); cropper=null; }
  cropper = new Cropper(img, {
    aspectRatio: 1,
    viewMode: 1,
    background: false,
    responsive: true,
    zoomOnWheel: true,
    dragMode: 'move'
  });
  $('#cropStatus').textContent = 'KÄ±rpma aktif. SÃ¼rÃ¼kle/zoom yap ve â€œKÄ±rp ve Kullanâ€a bas.';
});

$('#btnDoCrop').addEventListener('click', ()=>{
  if(!cropper){ $('#cropStatus').textContent='Ã–nce kÄ±rpmayÄ± baÅŸlat.'; return; }
  try{
    const canvas = cropper.getCroppedCanvas({
      width:512, height:512,
      imageSmoothingEnabled:true, imageSmoothingQuality:'high'
    });
    window.croppedDataURL = canvas.toDataURL('image/png', .92);
    $('#cropPreview').src = window.croppedDataURL;
    $('#previewInfo').textContent = '512Ã—512 PNG hazÄ±r';
    $('#cropStatus').textContent = 'KÄ±rpÄ±ldÄ±! GIF bÃ¶lÃ¼mÃ¼nde â€œKÄ±rpÄ±lmÄ±ÅŸ GÃ¶rseli Kullanâ€ diyebilirsin.';
    // GIF kaynaÄŸÄ±na otomatik set etmek istersen:
    setGifSource(window.croppedDataURL, 'KÄ±rpÄ±lmÄ±ÅŸ');
  }catch(err){
    console.error(err); $('#cropStatus').textContent = 'KÄ±rpma hata verdi.';
  }
});

/* ===================== GIF OluÅŸturucu ===================== */
let gifSource = "";  // dataURL
function setGifSource(src, from='â€”'){
  gifSource = src;
  $('#gifSourceImg').src = src;
  $('#gifSourceHint').textContent = `Kaynak: ${from}`;
}

$('#btnUseCropped').addEventListener('click', ()=>{
  if(!window.croppedDataURL){ alert('Ã–nce bir gÃ¶rseli kÄ±rp.'); return; }
  setGifSource(window.croppedDataURL, 'KÄ±rpÄ±lmÄ±ÅŸ');
});

$('#btnUseFromGallery').addEventListener('click', ()=>{
  if(images.length===0){ alert('Galeride gÃ¶rsel yok.'); return; }
  setGifSource(images[0].dataURL, 'Galeri (ilk gÃ¶rsel)');
});

const fpsEl = $('#fps'), durEl = $('#dur');
const fpsVal = $('#fpsVal'), durVal = $('#durVal');
fpsEl.addEventListener('input', ()=> fpsVal.textContent = fpsEl.value);
durEl.addEventListener('input', ()=> durVal.textContent = durEl.value);

$('#btnMakeGif').addEventListener('click', async ()=>{
  if(!gifSource){ alert('Ã–nce GIF iÃ§in kaynak seÃ§.'); return; }
  $('#gifStatus').textContent = 'OluÅŸturuluyorâ€¦ CihazÄ±na gÃ¶re birkaÃ§ saniye sÃ¼rebilir.';
  $('#btnDownloadGif').style.pointerEvents='none';
  $('#btnDownloadGif').style.opacity='.6';
  $('#gifPreviewBox').innerHTML = '<span class="hint">HazÄ±rlanÄ±yorâ€¦</span>';

  // gifshot tek kareyi loop ederek GIF oluÅŸturabilir.
  const fps = Number(fpsEl.value);
  const sec = Number(durEl.value);
  const totalFrames = Math.max(1, Math.round(fps * sec));

  // AynÄ± kareyi hafif zoom puls efekti ile Ã§oÄŸaltalÄ±m (hafif bÃ¼yÃ¼tme/kÃ¼Ã§Ã¼ltme)
  const frames = [];
  for(let i=0;i<totalFrames;i++){
    frames.push(gifSource);
  }

  gifshot.createGIF({
    images: frames,
    gifWidth: 512,
    gifHeight: 512,
    interval: 1/fps,
    numFrames: totalFrames,
    sampleInterval: 5,
    numWorkers: 2,
    // tek kare olduÄŸu iÃ§in animasyon etkisi sÄ±nÄ±rlÄ±; hafif titreÅŸim iÃ§in kullanÄ±ÅŸlÄ±dÄ±r
  }, function(obj){
    if(!obj.image){
      $('#gifStatus').textContent = 'GIF oluÅŸturulamadÄ±. FarklÄ± gÃ¶rsel/fps/sÃ¼re deneyin.';
      $('#gifPreviewBox').innerHTML = '<span class="hint">GIF baÅŸarÄ±sÄ±z</span>';
      return;
    }
    const dataURL = obj.image;
    const img = new Image();
    img.src = dataURL; img.style.maxWidth='100%'; img.style.borderRadius='10px';
    $('#gifPreviewBox').innerHTML = ''; $('#gifPreviewBox').appendChild(img);

    const a = $('#btnDownloadGif');
    a.href = dataURL; a.style.pointerEvents='auto'; a.style.opacity='1';
    $('#gifStatus').textContent = 'HazÄ±r! â€œGIFâ€™i Ä°ndirâ€ ile kaydedebilirsin.';
  });
});

/* ===================== Init ===================== */
loadImages();

</script>
</body>
</html>
